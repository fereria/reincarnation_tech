---
title: Pipeline考えながら理解するUSD(1) - 序章
---

# Pipeline考えながら理解するUSD(1) - 序章

近頃各所でUSDトークをするようになってきたのですが  
話しているとよく言われるのが **「なにに使うのかよくわからない」** ということです。  
実際の所、USDは名前だけ先行していて  
特に日本においては実体というか使い所がよく分からないという感じが強いかなという気がします。  
  
というわけで、せっかくなので色々とPipelineだったりWorkFlowだったりを考えて  
USDベースで構築してみる試みなんかをしてみようと思います。  
  
一応断っておくと、  
あくまでも仮定であり考察なのでコレが正しいというわけでもないですし  
実際の仕事でのフローとは異なる場合が多々あるともいます。  
（キャラ物、リアルタイムの映像制作から離れてだいぶ時間がたつので最近の事情はわからない...）  
ので、  
基本的には私の本職とは別モノ、  
あくまでも思考実験というか、こういう構造だったらどうだろうという考察として見てもらえるとうれしいです。  
  
というか、パイプラインって分野ごと会社ごとですべて違うので  
一律記事として書くのは難しいですよね。  

## 設定ファイルとして各アセットを管理するUSDを作ってみる

設定ファイル？アセットじゃないの？とも思うかもしれませんが  
USDはあくまでもファイルフォーマットであり、  
XMLだったりTOMLだったりYAMLだったりJSONだったり  
そういったファイルフォーマットと同種のものになります。  
  
ですが、それらのフォーマットに比較しても  
フォーマットとしての機能が非常に強力なので  
USDベースで各種設定データを構築すると  
色々と便利なことが多かったりします。  
  
ので、まずはアセットデータは忘れて  
一般的なアセット管理部分をどうしていったら良いのか整理してみます。

![](https://gyazo.com/d079aa37e9e793ac92cf8f35ececa292.png)

とりあえず基本的な構造はこんなかんじとしてみます。  
1つの大きなプロジェクトが存在していて、  
その下にアセットとシーケンス（映像部分のカット制作部分）に分かれ  
その下に細かい単位が来る形です。  
このあたりの構成はプロジェクトのタイプだったり、映像・ゲームとでだいぶ変わると思うので  
どういう構成に分類が作られるかは一番最初に整理する必要がある（はず）です。  
  
とりあえずは、比較的一般的な上の例を元に  
USDベースでの管理ファイルを作っていきます。  
まず、やりたいことは

1. Project.usdaにアクセスすることで、各要素にアクセスできるようにすること
2. ファイルは分割して個別に管理できるようにすること
3. PerforceやGit、SVNのようなバージョン管理でデータ管理をすること

この3つとします。  
  
### DBレスでのデータ管理

実際に構造を作っていく前に、アセット管理をなにでやるかについて軽く触れておきます。  
  
アセット管理をする上では色々とやり方はあると思うのですが、  
大きく分けるとDBでやるかファイルベースでやるかの2種類になるのではないかと思います。  
DBの場合は、自分でSQLサーバーを立てて構築する場合もありますし  
Shotgunのようなサービスを利用することもあります。  
  
もう1つがファイルベースでの管理。  
ファイルベースでやる場合にも何種類かあって

Excelでやる場合とテキストベースでやるのと、大きく2つに分かれます。  
テキストでやる場合には、保存形式には色々とあるのでそのいずれかによって  
各アセット情報などをファイルに保存して  
Python等の言語を使用してそのファイルを読み書きして、ステータスを管理する形になります。  
  
で。  
  
今回はこのファイルベースでの管理をJSONやYAML、TOML、XMLではなく  
USDベースでやっていきます。  
  
以前、私も各種情報をテキストベースで管理するパイプラインを作成したときはJSONベースで  
管理をしていました。  
  
そのときは何故ファイルベースに落ち着いたのかというと、
SQLiteやDJangoでサーバーを立てるパターン、Shotgunを使うパターンなども試したことがありますが  
DBを使う場合は構築がかなり大変だったりするし（一人では管理するのは限界がある）  
Shotgunは大人の事情でつかえなくなることもあるし、（セキュリティとかでNG食らうとか）  
Excelはネットワーク共有にしても破損の恐れがあったり、バージョン管理が難しかったりで  
~~アセット管理には向いてません。二度と使いたくありません。  ~~
  
というわけで、JSONベースでの管理はしていましたが  
USDのコンポジションアークは、ファイルベースでの管理を協力にサポートすることができるので  
せっかくなのでそれにのっかってみようという話です。  
ついでにUSDのコンポジションに関しても理解しやすくなります。  
  
## やってみよう

というわけで、アセット管理のシステムを考えてみます。  

![](https://gyazo.com/e01c4e11b46433a06e35affdb70bf398.png)

まずデータ部分のUSD含めて、全体像はこういう感じです。  
  
USD部分はバージョン管理ツール（SVN/Git/P4等）で管理をします。  
  
USDは、データベースとして使用しますが人間が直接書くわけではなく  
管理ソフトやMayaなどのDCCツールなどのランチャーツールから記述するようにします。  

### USDの骨格を作ろう
  
その前提でUSDファイルの構成を組んでみます。

![](https://gyazo.com/be429c2cfbe83b0e1a618203b0b8ccae.png)

まず、基本構成はアセットの基本構造基準でファイルを分けます。  
    
```
#usda 1.0
(
    defaultPrim="ch_girl"
)
def "ch_girl"
{
    
}
```
アセット設定と  
```
#usda 1.0
(
    defaultPrim="char"
)

def "char"
{
    def "ch_boy"(prepend references=@ch_boy.usda@){}
    def "ch_girl"(prepend references=@ch_girl.usda@){}
}
```
そのアセットタイプごとにまとめるusda  
```
#usda 1.0
(
    defaultPrim="assets"
)
def "assets"
{
    def "char"(prepend references=@char/index.usda@){}
    def "bg"(prepend references=@bg/index.usda@){}
    def "effects"(prepend references=@effects/index.usda@){}
    def "prop"(prepend references=@prop/index.usda@){}
}
```
分類をアセットしてまとめ、  
```
#usda 1.0

def "project"
{
    def "assets"(prepend references=@assets/assets.usda@){}
}
```
プロジェクト下にアセットusdaを読み込みます。  
  
見ての通り、すべてのコンポジションアークは「リファレンス」を使用して作成しています。  

![](https://gyazo.com/bf0be0a2de425c8442b84ec5b8e13d69.png)

usdaファイルのツリーはこのような階層にしてみました。  
  
![](https://gyazo.com/bc3ecf3966546589638572e996554ce2.png)

その結果このようなツリーができあがります。  
これが、このプロジェクトの基本的な骨格部分になっていきます。  
このままだと全く意味がないので、この骨格に対して具体的なアセット管理のデータを肉付けしていってみます。

!!! info
    今はusdaファイルはすべて1つのフォルダしたにまとめるようにしてますが  
    アセットのモデルやテクスチャデータがある場合はそのフォルダ下にsettingsフォルダを入れて  
    その下にUSDを入れるという案も考えられます

最終的にできあがっているツリーは、1つのXMLやJSON等で作成したとしても同じような  
構造を作成することができます。  
ですが、多くのアセットを管理する場合は  
多くの人が設定ファイルを更新することになるため、ファイル単位が大きくなると  
衝突が頻繁に起こり、非常に面倒になります。  
  
では、Jsonなどで小分けに作ればいいじゃない？と思うかもしれませんが  
その当たりのメリットはこのベースを徐々に拡張して  
アセット管理のシステムを構築していくとメリットが見えてくるんじゃないかと思います。  

### どの階層にもアクセスできるUSD

USDの面白いところは、USDのリファレンスなどを使用してツリー構造を作っている場合  
どの階層でも普通に開くことができることです。  
上のツリー構造は proj_root.usda ファイルを開いた結果の構造になっていますが  
たとえば、 ch_girl.usda を開くと

![](https://gyazo.com/8a4e6fd17ec2d4cedf5d5baa26104713.png)

このようにルート下に ch_girlのプリムがある状態になりますし

![](https://gyazo.com/3b13c8ad20182a990383e4f049c544d9.png)

char下のindex.usdaを開くと、キャラのプリム以下の構造のみが表示されます。  
  
USDファイル（＝レイヤー）というのは、いわゆる「作業単位」であり「作業者がアクセスする単位」  
という意味合いがあります。  
ので、多層化された構造であっても  
前後を意識することなく、どのUSDファイルでも開くことができ  
開いたファイルがルートとしてシーングラフを作る事が出来ます。  
  
これはアセット管理ツールを作る上では非常にお得です。  
何故かというと、DCCツールの「アセットランチャーを作りたい」となった時、  
アセットの一覧をツリービューで表示したいという場合は「assets.usda」を読み込めば良いし  
書き込む場合もこのassets.usdaに対して編集  
あるいは個別のアセットごとのレイヤーを編集すれば良いわけです。  
  
USDでのパイプラインを構築する場合は  
この **「どの階層でも開くことが出来る」** という特性から、 **「作業者単位でのレイヤー分け」** というのが  
ファイルの粒度をどのようにするのかを考慮する上で、とても重要になってきます。  
  
  
というわけで、だいぶ長くなってきたので基本的な骨格部分はここまで。  
次回は各アセット層のプリムの構成について  
色々と考えてみます。  
