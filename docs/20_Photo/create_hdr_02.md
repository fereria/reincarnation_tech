# 全周パノラマを作る - 現像編

<!-- SUMMARY:全周パノラマを作る（現像編）-->

前回の [撮影編](create_hdr_01.md) で撮影した画像を、加工していきます。  
  
まずは、撮影した画像をPCに取り込んで、現像処理をおこないます。  
使用ソフトはLightroom。  
撮影はRAWの最高設定で撮影しているので、そのRAWをLightroomに読み込むときに  
DNGに変換をしています。  

## スタックにまとめる

![](https://gyazo.com/3abb0ef34c39c0d420e9261a96c8f49f.png)

画像を取り込んだら、１セットごとにスタックにまとめておきます。  

![](https://gyazo.com/ce6933db0c5ab898fb7ca953579d88a0.png)

この機能自体を今回初めて知りましたが、スタックにまとめると  
こんな感じに複数の写真をまとめることができます。  
  
## カラープロファイルを作成・適応

DNGでPCに取り込んだら、まずはカラープロファイルを作成します。  
作成方法は [カラーパスポートの使用方法](color_passport.md) に書いてある通りです。  
DNGで取り込んでおけば、あとはツールにドラッグ＆ドロップすることで  
読み込むことができます。  
  
![](https://gyazo.com/83dbf89827cc45dfe8638ea69d39e2c6.png)

撮影時は、かならずパスポートを撮影しているので  
加工したいセット（Ev2.0違い5枚＋上下足消しの計50枚）のカラーパスポートEv0の写真を  
選択します。  
  
![](https://gyazo.com/c7a417d7355ac347ecf5c5b4491d0709.png)

ここで、作成したDNGプロファイルを選択します。  
  
次に、ホワイトバランスを変更します。  
  
![](https://gyazo.com/f909cba21ddf6541dedbc20209cb3a7c.png)

ホワイトバランスのピッカーで、赤枠内の色をクリックして  
ホワイトバランスの調整を行います。  
  
中央がニュートラルで、上ほどブルー・グリーン、下ほど暖色になるように  
調整されます。  
今回は、若干寒色寄りにしたかったので、上から2つ目でホワイトバランスの調整をしました。  
  
パスポートの使い方の詳細が、下のサイトにありましたので参考にしました。
https://www.denjuku.org/old/review/201004/  
  
設定が完了したら、この設定を他の写真にコピーします。  
  
![](https://gyazo.com/3246ea96266615ec23a5827213f2a63b.png)

現像設定→設定をコピー　にして、

![](https://gyazo.com/77d089d5880e3b8a93ad2e60a0b7e4cc.png)

「色表現とプロファイル」と「ホワイトバランス」にチェックを入れてコピーします。  
次に、全周の素材を選択して、設定をペーストでペーストします。  
  
ここまで完了したら、

![](https://gyazo.com/e980916c478c5c449a2afb90bd774b9b.png)

画像の書き出しを行います。  
設定は、TIFFの16bit＋圧縮無し＋カラースペースsRGBにします。  
  
## 全周画像に加工する

画像の準備ができたら、次に撮影した画像を全周に加工します。  
加工ソフトは [PTGui Pro](https://www.ptgui.com/) を使用しています（現状はテスト版）  
  
まずは、プロジェクトアシスタンスのタブに全画像（50枚すべて）をD&Dします。  

![](https://gyazo.com/c9a1ff0c9c1b52f8360c50d1ff6ba9ba.png)

そのあと、「HDRブラケット露出をリンク」をクリックします。  

![](https://gyazo.com/378475451d039ae899396358f36a22a2.png)

クリックすると、自動で写真がブラケット撮影した写真ごとにまとめられます。  
まとめたあと、「画像を整列する」ボタンを押して、コントロールポイントを追加します。  
  
コントロールポイントは、画像と画像の同じピクセル位置を設定するためのマーカー  
のようなもの。  
  
![](https://i.gyazo.com/32adc98699cc80c29c8508275d097164.jpg)

こんな感じで、隣り合っている画像のうち  
同じポジションのばしょが番号でセットされます。  
ここの精度が、画像同士をつなげる「スティッチ」処理の精度に大きく関わってきて  
概ねピクセルごとの距離（誤差？）が5以内の優良なポイントが複数あると  
綺麗につながります。  

![](https://gyazo.com/6c332b4361eb2ee5e834633055d80ff4.png)

デフォルトだと、精度の悪いポイントもけっこうあるので  
コントロールポイント→使えないコントロールポイントを削除  
で、いらないポイントをいったん削除します。  
  
## 三脚削除

コントロールポイントの整理を行ったら、次に三脚消しをおこないます。  
  
![](https://gyazo.com/070842c49d10a09d83e991ddf3e1dc04.png)

「マスク」タブを選択して、写真の8～10の下位置撮影した写真に対して  
マスク処理をします。  
  
![](https://gyazo.com/3fbb9a8694a147e9f028899c10743761.jpg)

こんなかんじで、三脚が置いてある位置をペイントでぬりぬりします。  
  
![](https://gyazo.com/a9883a6308a812df70b703720039a5e8.jpg)

撮影した下向き画像が正しく撮影できていれば、  
マスクを作成した段階で綺麗に三脚を消すことができました。  
  
三脚消し用の画像（10）の位置が微妙だったり、下向き180度画像がなかったりすると  
綺麗に三脚が消せない事がありましたので  
撮影時には気をつける必要があります。  
  
ここまで準備ができたら、「オプティマイザ」の「オプティマイザの実行」を押します。  
  
![](https://gyazo.com/1e5944c30bdead09c81d42c051144dee.png)

ここで、コントロールポイントの距離数値が基準以下の場合「あまり良くない」などの評価を受けます。  
が、とりあえずスルー。  
  
最後に、正しく繋がっているか「プレビュー」で確認をします。  
  
![](https://i.gyazo.com/b806852595be34e0d0f9d60e4818ee72.gif)

無事三脚を消すことができました。  
  
## 出力する

最後に出力をします。

![](https://gyazo.com/ec50324d6cdba2256d3352e3711aa750.png)

「露出合成/HDR」タブを選択して、「トゥルーHDR」をクリックします。  
そのあと「自動露出と色補正」から「今すぐ最適化」を押します。  

![](https://gyazo.com/be8147cd8f650a0a8ba4f77b3a98f20c.png)

そのあと、パノラマを作成するタブを選択して、  
出力の「トーンマッピングパノラマ」と「HDRパノラマ」を選択します。  
  
検索をかけていた時に困るのがこの「HDR」と呼ばれる単語。  
カメラ界隈と3DCG界隈とで微妙に言葉の意味が違っていてけっこう困ったりします。  
  
ここでいう「HDRパノラマ」というのは、16bitまたは32bit画像のことを指していて  
IBLなどの処理をするときなどに色の段階が256以上の精度が欲しいときに使用する「HDR画像」を  
指しています。  
対して、トーンマッピングパノラマというのは「HDR合成」のことをさしていて  
複数の露出で撮影した画像を合成して、暗すぎるところや明るすぎるところを  
いい感じに組み合わせて合成してくれる処理をさしています。  
いわゆるiPhoneなどででてくる「HDR」はこちらのこと。  
  
私の場合は、3DCGでの素材を前提にしているので「HDRパノラマ」を作成します。  
この設定をONにするためには「露出合成/HDR」タブでトゥルーHDRにする必要があります。  
  
このHDR出力の形式はいくつかありますが、今回は「HDR」形式で出力します。  
  
![](https://gyazo.com/48928c0b3846c8778d0fe5c338c94456.png)

出力結果はこちら。  
20k × 10k サイズの16bit画像なので、当然のことながらとんでもないファイルサイズになってしまいます。  
ので、必要に応じて画像サイズを小さくして出力します。  
この辺の適正値は現状まだ不明です。  
（さすがに800MBのHDRは実用には耐えられない...）  
  
ここまでが、LightroomとPTGUIを使用した全周加工手順の基本形です。  
PTGui自体まだいろいろ調整項目があるので、調整することで最適化できるとおもいますが  
撮影をきちんとしておけば、画像作成そのものはネットで調べた内容よりかなり楽になっている気がします。  

https://remi-saba.net:5001/mo/sharing/Us3WShtVt

作成した画像を自宅のSynologyMomentsに追加してみたやつ。  
実際はもうすこし画質が良いのですが、UPした都合ボケボケなのと、天井と地面が正しく展開されてないので  
参考程度ですが...  
というか、全周公開する手立てがほとんどないですね(´・ω・`)
  
## まとめ

おおむね最終的な画像作成までの手順は理解できましたが  
実用的なものに落とし込む場合は出力設定のリサーチが必要なのと、  
コントロールポイントの調整回りはまだまだ改善の余地がある気がします。  
  
ので、次は実践編としてどこかに撮影にいきつつ  
いろんなパターンの撮影とその加工をしていこうとおもいます。  
  
おおむね検証できたし、そろそろPTGui買おう...