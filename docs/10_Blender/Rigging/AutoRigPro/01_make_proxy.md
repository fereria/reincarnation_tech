# Link と Proxy を使用して Anim 用シーンを作る 1

<!-- SUMMARY:LinkとProxyを使用してAnim用シーンを作る(1) -->

3DCG のワークフローは  
モデリング → リギング → アニメーション → エフェクト  
このように進んでいくが、多くの場合アニメーション作業をしながら  
モデリング作業を並行して行い、あとで差し替える...こういった進め方をとることが多い。

Maya の場合は、このフローで作業をするために  
「リファレンス」を使用して、アニメーションシーンではリファレンスでモデルを読み込み  
読み込み元のリファレンスモデルを、都度更新していくような進め方をとる。

それでは、Blender の場合はどうやってモデルの作成・リグの更新・アニメーション作成  
を、同時並行していけばよいのか？

というのをいろいろ検証してみようとおもいます。

## Link について

Blender には Maya のリファレンスににた機能で「Link」というものがあります。  
その名の通り、べつの Blend ファイルにある各種オブジェクトやコレクション、シーンなどを  
「リンク」することにより、リンク先でなにかしら変更があった場合  
リンクしたファイル内にも、自動で更新が適応されるというものです。

Maya のリファレンスとの大きな違いは２つ。  
1 つ目は、Maya はシーンファイル（ma/mb）ファイル単位でシーンに読み込むのに対し  
Blender は Blend ファイル内のオブジェクト単位（Maya 的に言えばノード単位）  
でもリンクを作成できるということ。

もう１つは、Maya のリファレンスは  
読み込んでしまえばそのまま移動したり編集したりすることができますが  
Blender の Link は、読み込んだ後は編集したりアニメーションすることができません。  
（これには後述の Proxy を使用します）

今回は、この Link を使用してアニメーションできるシーンを作っていきます。

## Link を作成

![](https://gyazo.com/bb83892d5c992989b80ca81c8b56f70d.png)

まず、File から Link を選択

![](https://gyazo.com/b6fa07e55f3021ff8408150193bac2e9.png)

読み込みたいモデルの Blend ファイルをクリックすると  
Data-Block の各種フォルダがあるので、とりあえず Collection の RIG を読み込む。

![](https://gyazo.com/5413d0f6d56e4b6803eb880b11c2cdd1.png)

読み込むモデルは、AutoRigPro を使用してセットアップしたものを使用します。  
デフォルトで、  
Chara 名の Collection の子供に RIG と RIG 用のパーツのコレクションが作成されてるので  
今回はこの \_rig という Collection のみを読み込むようします。  
ので、モデルデータもこの\_rig 内に入れておきます。

{% hint style="info" %}
Collection の Link は、あくまでも「Collection 内にあるオブジェクトを Link」するであり  
Maya のように「コネクションがあったら無理矢理引きづられてくる」ような挙動はありません。  
ので、RIG とあわせてモデルも読む必要があるなら  
モデルも Link する Collection 内に置いてく必要がある。  
{% endhint %}

![](https://gyazo.com/c5c03098feb0b967f73a337d3b9046b6.png)

読み込むと、こんな感じで RIG のコレクションが読み込まれます。

![](https://gyazo.com/8f4011238a59fa36984096488c4f933e.png)

モデルも読み込まれました。

## アーマチュアを選べるようにする

が。

この状態だと、コレクションがオブジェクトのように１つにまとまってしまい  
その中のアーマチュアを選択することがなぜかできません。

Pose モードにもできないので、アニメーションもできないし  
そもそも Link だとキーをうったりも出来ないので  
アニメーションもできません。  
ので、一手間入れてできるようにします。

![](https://gyazo.com/3008b9ab7f27550e0ddc277d97f65b1b.gif)

まず、読み込んだコレクションを開いていき、「character_rig」のコレクションを  
ドラッグ＆ドロップで外に出します。  
（ここでいう character_rig とは、アーマチュアが入っているコレクションのこと）

次に、読み込んできた時のオブジェクトとリンクしたオブジェクトが残っているので  
コレクションを選び、Unlink します。  
こうすると、コレクション以下のオブジェクトも  
リンクしたまま選択出来るようになります。

{% hint style="info" %}
これでやりたいことはできたけど、  
ほんとうにこれが正規の手順なのかは謎。
{% endhint %}

## Proxy を作成する

この状態になったら

![](https://gyazo.com/d9a9d51169e65eae1d493b22f5686517.png)

\_rig のコレクション内から「rig」のアーマチュアを選択し

![](https://gyazo.com/884ee8fcbaecf50f7809fba0c1be0a5a.png)

Object -> Relations -> Make Proxy.. を選択します。  
この Proxy を作成することで、モデルを編集したりアニメーションさせたりできるようになります。

![](https://gyazo.com/8f35a0dcceea4568f258555fb2bb1d72.png)

Proxy を作成すると、このようなオブジェクトが作成されます。

![](https://gyazo.com/c8092f0bb175b4456d53466c45566016.png)

Proxy を作る前の rig オブジェクトは、このように PoseMode に移行することもできません。

![](https://gyazo.com/1848a045f71b5248b095de811447f6f4.png)

が、Proxy で作成したノードは PoseMode に移行することができます。

![](https://gyazo.com/1df022873d1ba17a79f8cee634be3aa9.gif)

（一部モデルぶっとんでますが、それを除けば）  
RIG の Proxy を動かすと、Link オブジェクト（編集不可）側のモデルもちゃんと動きました。

## あとで Link 元を編集できるかテスト

![](https://gyazo.com/a90fd4b0a177c9e10215326df5d264e1.png)

テストで、リンク元のコレクションの構造を変えて  
中のモデルを外してみました。
その後、Link 先シーンを開くと  
モデルがひょうじされなくなっているのがわかります。

![](https://gyazo.com/d0ef2621bd23832d6b5f74cc6009e8a4.png)

コントローラーの形状を Link 元で変更しても

![](https://gyazo.com/e9ba5920716e25bd78e10c13df3bd777.png)

ちゃんと反映されました。

## まとめ

キャラモデルのアニメーションでも Proxy 作らなければいけないということは  
RIG のコントローラーの数分 Proxy を作らないといけないのか・・・？と思ってましたが  
コントローラーもアーマチュアの一部扱いなので  
アーマチュア 1 つだけ Proxy を挟めばアニメーションが挟めることがわかったので  
そこまで手間をかけずにアニメーション用シーンを構築できることがわかりました。

親子化されたコレクションを Link で読み込むと、アーマチュアとかが選択できなくなるのも  
外に移動すれば OK なので...コレで良いのかは別にして  
なんとかなりそうだと分かったのでよしとする。

Link で RIG 読める事がわかったのと、コレクション単位での Link が行ける事がわかったので  
ようやく、コレクションの構造をどうしたら良いとか  
どうやってアセットデータを持てば良いのかが考えられるようになった...かな...

## おまけ

親子化されてると Link がおかしくなるなら、直下にアーマチュアがあるわけじゃない  
コレクションのコレクションを Link にしたら表示できなくなるのか？  
と思ってテストしてみましたが

![](https://gyazo.com/e2e6c06256068edb412dd65a2a814549.png)

ドラッグ＆ドロップで外に出せば、リンク先に子コレクションがあっても  
普通に中身の表示が出来る模様。  
なんとなくですが、この挙動バグなんじゃないかな...？
